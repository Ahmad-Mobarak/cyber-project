/*
    General Malware Detection Rules
    These rules detect common malware indicators and behaviors
*/

rule Suspicious_Imports {
    meta:
        description = "Detects suspicious Windows API imports commonly used by malware"
    strings:
        $process1 = "CreateProcess" ascii wide
        $process2 = "VirtualAlloc" ascii wide
        $process3 = "WriteProcessMemory" ascii wide
        $process4 = "CreateRemoteThread" ascii wide
        $inject1 = "LoadLibrary" ascii wide
        $inject2 = "GetProcAddress" ascii wide
        $inject3 = "VirtualProtect" ascii wide
        $sys1 = "CreateService" ascii wide
        $sys2 = "StartService" ascii wide
        $reg1 = "RegCreateKey" ascii wide
        $reg2 = "RegSetValue" ascii wide
    condition:
        3 of them
}

rule Suspicious_Commands {
    meta:
        description = "Detects suspicious command strings commonly used by malware"
    strings:
        $cmd1 = "cmd.exe" ascii wide nocase
        $cmd2 = "powershell" ascii wide nocase
        $cmd3 = "wscript" ascii wide nocase
        $cmd4 = "cscript" ascii wide nocase
        $cmd5 = "bitsadmin" ascii wide nocase
        $cmd6 = "certutil" ascii wide nocase
        $sys1 = "net.exe" ascii wide nocase
        $sys2 = "netsh" ascii wide nocase
        $sys3 = "taskkill" ascii wide nocase
        $sys4 = "schtasks" ascii wide nocase
    condition:
        2 of them
}

rule Suspicious_Network {
    meta:
        description = "Detects suspicious network-related indicators"
    strings:
        $net1 = "WinHttp" ascii wide
        $net2 = "WinInet" ascii wide
        $net3 = "InternetOpen" ascii wide
        $net4 = "InternetConnect" ascii wide
        $net5 = "HttpSendRequest" ascii wide
        $net6 = "WSAStartup" ascii wide
        $net7 = "connect" ascii wide
        $net8 = "recv" ascii wide
        $net9 = "send" ascii wide
    condition:
        3 of them
}

rule Suspicious_Files {
    meta:
        description = "Detects suspicious file operations"
    strings:
        $file1 = "CreateFile" ascii wide
        $file2 = "WriteFile" ascii wide
        $file3 = "CopyFile" ascii wide
        $file4 = "MoveFile" ascii wide
        $file5 = "DeleteFile" ascii wide
        $path1 = "\\Windows\\Temp\\" ascii wide nocase
        $path2 = "\\AppData\\Local\\Temp\\" ascii wide nocase
        $path3 = "\\ProgramData\\" ascii wide nocase
    condition:
        2 of ($file*) and 1 of ($path*)
}

rule Suspicious_Persistence {
    meta:
        description = "Detects common persistence mechanisms"
    strings:
        $reg1 = "Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
        $reg2 = "Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce" ascii wide nocase
        $reg3 = "System\\CurrentControlSet\\Services" ascii wide nocase
        $reg4 = "Software\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\AppInit_DLLs" ascii wide nocase
        $reg5 = "Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" ascii wide nocase
        $startup = "\\Startup\\" ascii wide nocase
    condition:
        any of them
}

rule Suspicious_AntiAnalysis {
    meta:
        description = "Detects anti-analysis techniques"
    strings:
        $dbg1 = "IsDebuggerPresent" ascii wide
        $dbg2 = "CheckRemoteDebuggerPresent" ascii wide
        $dbg3 = "OutputDebugString" ascii wide
        $vm1 = "VMware" ascii wide nocase
        $vm2 = "VBox" ascii wide nocase
        $vm3 = "QEMU" ascii wide nocase
        $time1 = "GetTickCount" ascii wide
        $time2 = "QueryPerformanceCounter" ascii wide
    condition:
        2 of them
}

rule Suspicious_Encryption {
    meta:
        description = "Detects potential encryption/decryption routines"
    strings:
        $crypt1 = "CryptoAPI" ascii wide
        $crypt2 = "Crypt32" ascii wide
        $crypt3 = "CryptDecrypt" ascii wide
        $crypt4 = "CryptEncrypt" ascii wide
        $crypt5 = "RijndaelManaged" ascii wide
        $crypt6 = "AesCryptoServiceProvider" ascii wide
        $enc1 = {32 33 34 35 36 37 38 39 41 42 43 44 45 46 47 48} // Base64 alphabet
        $enc2 = "base64" ascii wide nocase
    condition:
        2 of them
}

rule Suspicious_Evasion {
    meta:
        description = "Detects common evasion techniques"
    strings:
        $sleep1 = "Sleep" ascii wide
        $sleep2 = "WaitForSingleObject" ascii wide
        $inject1 = "WriteProcessMemory" ascii wide
        $inject2 = "CreateRemoteThread" ascii wide
        $hollow1 = "ZwUnmapViewOfSection" ascii wide
        $hollow2 = "NtUnmapViewOfSection" ascii wide
    condition:
        2 of them
}

rule Suspicious_Keylogger {
    meta:
        description = "Detects potential keylogging functionality"
    strings:
        $api1 = "GetAsyncKeyState" ascii wide
        $api2 = "GetKeyboardState" ascii wide
        $api3 = "SetWindowsHookEx" ascii wide
        $api4 = "GetForegroundWindow" ascii wide
        $api5 = "GetWindowText" ascii wide
    condition:
        2 of them
}

rule Suspicious_Screenshot {
    meta:
        description = "Detects potential screenshot functionality"
    strings:
        $api1 = "BitBlt" ascii wide
        $api2 = "GetDC" ascii wide
        $api3 = "GetDesktopWindow" ascii wide
        $api4 = "CreateCompatibleBitmap" ascii wide
        $api5 = "CreateCompatibleDC" ascii wide
    condition:
        3 of them
} 